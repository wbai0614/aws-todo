<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<link rel="icon" href="data:,">
<title>Serverless Task Manager</title>

<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    min-height: 100vh;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
}

.app {
    width: 100%;
    max-width: 500px;
    background: #fdfdfd;
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

h1 {
    text-align: center;
    margin: 0 0 24px;
    font-weight: 700;
    color: #333;
}

.input-row {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}

input[type="text"] {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #ddd;
    font-size: 15px;
    transition: border 0.2s, box-shadow 0.2s;
}

input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
}

button {
    border: none;
    border-radius: 10px;
    padding: 10px 16px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.add-btn {
    background: #667eea;
    color: white;
    box-shadow: 0 6px 14px rgba(102,126,234,0.4);
}

.add-btn:hover {
    background: #5a6fdc;
    transform: translateY(-1px);
}

.filters {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 16px;
}

.filter-btn {
    background: #f1f1f1;
    color: #333;
    padding: 6px 14px;
    border-radius: 8px;
}

.filter-btn.active {
    background: #667eea;
    color: white;
}

ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: grab;
    background: #e0f2fe;
    transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
}

li.completed {
    background: #f3f4f6;
}

li.dragging {
    opacity: 0.5;
    transform: scale(0.98);
    box-shadow: 0 12px 24px rgba(0,0,0,0.2);
}

li span {
    flex: 1;
    margin-left: 8px;
    font-size: 15px;
    color: #111;
}

li.completed span {
    text-decoration: line-through;
    color: #777;
}

li:hover {
    transform: translateY(-2px);
}

.delete-btn {
    background: #ef4444;
    color: white;
    font-size: 12px;
    padding: 6px 10px;
    border-radius: 8px;
    transition: all 0.2s;
}

.delete-btn:hover {
    background: #dc2626;
    transform: translateY(-1px);
}

.empty {
    text-align: center;
    margin-top: 20px;
    color: #888;
    font-style: italic;
}

footer {
    text-align: center;
    margin-top: 16px;
    font-size: 12px;
    color: #aaa;
}
</style>
</head>

<body>
<div class="app">
    <h1>ðŸš€ Serverless Tasks</h1>

    <div class="input-row">
        <input id="taskInput" type="text" placeholder="Add a task..." />
        <button class="add-btn" onclick="addTask()">Add</button>
    </div>

    <div class="filters">
        <button class="filter-btn active" onclick="setFilter('all')">All</button>
        <button class="filter-btn" onclick="setFilter('active')">Active</button>
        <button class="filter-btn" onclick="setFilter('completed')">Completed</button>
    </div>

    <ul id="taskList"></ul>
    <div id="emptyState" class="empty" style="display:none;">No tasks ðŸŽ‰</div>

    <footer>Drag tasks to reorder</footer>
</div>

<script>
const API_URL = "https://7jgwzjme1f.execute-api.us-east-1.amazonaws.com/prod/tasks";
let allTasks = [];
let currentFilter = "all";
let draggedItem = null;

// FILTER
function setFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
    event.target.classList.add("active");
    renderTasks();
}

// LOAD TASKS
async function loadTasks() {
    try {
        const res = await fetch(API_URL);
        allTasks = await res.json();
        if (!Array.isArray(allTasks)) allTasks = [];
        allTasks.sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
        renderTasks();
    } catch (err) {
        console.error("Error loading tasks:", err);
    }
}

// RENDER TASKS
function renderTasks() {
    const list = document.getElementById("taskList");
    const empty = document.getElementById("emptyState");
    list.innerHTML = "";

    let tasks = allTasks;
    if (currentFilter === "active") tasks = tasks.filter(t => !t.completed);
    if (currentFilter === "completed") tasks = tasks.filter(t => t.completed);

    if (tasks.length === 0) {
        empty.style.display = "block";
        return;
    }
    empty.style.display = "none";

    tasks.forEach(task => {
        const li = document.createElement("li");
        li.draggable = true;
        li.dataset.id = task.taskId;
        if (task.completed) li.classList.add("completed");

        // DRAG EVENTS
        li.addEventListener("dragstart", () => {
            draggedItem = li;
            li.classList.add("dragging");
        });
        li.addEventListener("dragend", () => {
            li.classList.remove("dragging");
            draggedItem = null;
            saveOrder();
        });
        li.addEventListener("dragover", e => {
            e.preventDefault();
            const after = getDragAfterElement(list, e.clientY);
            if (!after) list.appendChild(draggedItem);
            else list.insertBefore(draggedItem, after);
        });

        // CHECKBOX
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = task.completed;
        checkbox.addEventListener("change", () => toggleTask(task.taskId, !task.completed));

        const span = document.createElement("span");
        span.textContent = task.title;

        const del = document.createElement("button");
        del.textContent = "Delete";
        del.className = "delete-btn";
        del.onclick = () => deleteTask(task.taskId);

        li.appendChild(checkbox);
        li.appendChild(span);
        li.appendChild(del);
        list.appendChild(li);
    });
}

// DRAG HELPER
function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll("li:not(.dragging)")];
    let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
    draggableElements.forEach(child => {
        const box = child.getBoundingClientRect();
        const offset = y - (box.top + box.height / 2);
        if (offset < 0 && offset > closest.offset) {
            closest.offset = offset;
            closest.element = child;
        }
    });
    return closest.element;
}

// SAVE ORDER
async function saveOrder() {
    const items = [...document.querySelectorAll("li")];
    const updatedOrder = items.map((li, i) => ({ taskId: li.dataset.id, updates: { order: i } }));

    for (const item of updatedOrder) {
        try {
            await fetch(API_URL, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(item)
            });
        } catch (err) {
            console.error("Error saving order:", err);
        }
    }
    loadTasks();
}

// CRUD
async function addTask() {
    const input = document.getElementById("taskInput");
    if (!input.value.trim()) return;

    await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: input.value })
    });

    input.value = "";
    loadTasks();
}

async function deleteTask(id) {
    await fetch(`${API_URL}?taskId=${id}`, { method: "DELETE" });
    allTasks = allTasks.filter(t => t.taskId !== id);
    renderTasks();
}

async function toggleTask(id, completed) {
    await fetch(API_URL, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ taskId: id, updates: { completed } })
    });
    loadTasks();
}

// INITIAL LOAD
loadTasks();
</script>
</body>
</html>
