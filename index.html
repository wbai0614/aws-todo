<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<link rel="icon" href="data:,">
<title>Serverless Task Manager</title>

<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    min-height: 100vh;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
}

.app {
    width: 100%;
    max-width: 500px;
    background: white;
    border-radius: 14px;
    padding: 28px;
    box-shadow: 0 25px 40px rgba(0,0,0,0.25);
}

h1 {
    text-align: center;
    margin: 0 0 20px;
    font-weight: 700;
}

.input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 14px;
}

input[type="text"] {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 15px;
}

button {
    border: none;
    border-radius: 8px;
    padding: 10px 14px;
    cursor: pointer;
    font-size: 14px;
}

.add-btn {
    background: #667eea;
    color: white;
}

.add-btn:hover {
    background: #5a6fdc;
}

.filters {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 14px;
}

.filter-btn {
    background: #f1f1f1;
    color: #333;
    padding: 6px 12px;
}

.filter-btn.active {
    background: #667eea;
    color: white;
}

ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: grab;
    background: white;
}

li.dragging {
    opacity: 0.5;
}

li.completed span {
    text-decoration: line-through;
    color: #999;
}

span {
    flex: 1;
    margin-left: 8px;
}

.delete-btn {
    background: #ef4444;
    color: white;
    font-size: 12px;
    padding: 6px 10px;
}

.delete-btn:hover {
    background: #dc2626;
}

.empty {
    text-align: center;
    margin-top: 20px;
    color: #888;
}

footer {
    text-align: center;
    margin-top: 16px;
    font-size: 12px;
    color: #aaa;
}
</style>
</head>

<body>
<div class="app">
    <h1>ðŸš€ Serverless Tasks</h1>

    <div class="input-row">
        <input id="taskInput" type="text" placeholder="Add a task..." />
        <button class="add-btn" onclick="addTask()">Add</button>
    </div>

    <div class="filters">
        <button class="filter-btn active" onclick="setFilter('all')">All</button>
        <button class="filter-btn" onclick="setFilter('active')">Active</button>
        <button class="filter-btn" onclick="setFilter('completed')">Completed</button>
    </div>

    <ul id="taskList"></ul>
    <div id="emptyState" class="empty" style="display:none;">No tasks ðŸŽ‰</div>

    <footer>Drag tasks to reorder</footer>
</div>

<script>
const API_URL = "https://7jgwzjme1f.execute-api.us-east-1.amazonaws.com/prod/tasks";
let allTasks = [];
let currentFilter = "all";
let draggedItem = null;

// FILTER LOGIC
function setFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
    event.target.classList.add("active");
    renderTasks();
}

// LOAD TASKS
async function loadTasks() {
    const res = await fetch(API_URL);
    allTasks = await res.json();
    allTasks.sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
    renderTasks();
}

// RENDER TASKS
function renderTasks() {
    const list = document.getElementById("taskList");
    const empty = document.getElementById("emptyState");
    list.innerHTML = "";

    let tasks = allTasks;
    if (currentFilter === "active") tasks = tasks.filter(t => !t.completed);
    if (currentFilter === "completed") tasks = tasks.filter(t => t.completed);

    if (tasks.length === 0) {
        empty.style.display = "block";
        return;
    }
    empty.style.display = "none";

    tasks.forEach(task => {
        const li = document.createElement("li");
        li.draggable = true;
        li.dataset.id = task.taskId;
        if (task.completed) li.classList.add("completed");

        // Drag events
        li.addEventListener("dragstart", () => {
            draggedItem = li;
            li.classList.add("dragging");
        });
        li.addEventListener("dragend", () => {
            li.classList.remove("dragging");
            saveOrder();
        });
        li.addEventListener("dragover", e => {
            e.preventDefault();
            const after = getDragAfterElement(list, e.clientY);
            if (after == null) list.appendChild(draggedItem);
            else list.insertBefore(draggedItem, after);
        });

        // Checkbox to mark completed
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = task.completed;
        checkbox.addEventListener("change", () => toggleTask(task.taskId, task.completed));

        const span = document.createElement("span");
        span.textContent = task.title;

        const del = document.createElement("button");
        del.textContent = "Delete";
        del.className = "delete-btn";
        del.onclick = () => deleteTask(task.taskId);

        li.appendChild(checkbox);
        li.appendChild(span);
        li.appendChild(del);
        list.appendChild(li);
    });
}

// DRAG HELPERS
function getDragAfterElement(container, y) {
    const items = [...container.querySelectorAll("li:not(.dragging)")];
    return items.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        return offset < 0 && offset > closest.offset ? { offset, element: child } : closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// SAVE ORDER
async function saveOrder() {
    const items = [...document.querySelectorAll("li")];
    for (let i = 0; i < items.length; i++) {
        await fetch(API_URL, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                taskId: items[i].dataset.id,
                order: i
            })
        });
    }
    loadTasks();
}

// CRUD FUNCTIONS
async function addTask() {
    const input = document.getElementById("taskInput");
    if (!input.value.trim()) return;

    await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: input.value })
    });

    input.value = "";
    loadTasks();
}

async function deleteTask(id) {
    await fetch(`${API_URL}?taskId=${id}`, { method: "DELETE" });
    loadTasks();
}

async function toggleTask(id, completed) {
    await fetch(API_URL, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ taskId: id, completed: !completed })
    });
    loadTasks();
}

// INITIAL LOAD
loadTasks();
</script>
</body>
</html>
